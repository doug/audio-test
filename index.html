<html>
<head>
  <title></title>
</head>
<body>
<div>status</div>
<div id='display'></div>
<div>current seconds</div>
<div id='seconds'></div>
<button id='play' onclick='play();' disabled='true'>play</button>
<button id='stop' onclick='stop();' disabled='true'>stop</button>
<script src='clocksync.js'></script>
<script>

  var iOS = ( navigator.userAgent.match(/(iPad|iPhone|iPod)/g) ? true : false );

  var buffer, context, source;

  var display = document.getElementById('display');
  var seconds = document.getElementById('seconds');
  var playb = document.getElementById('play');
  var stopb = document.getElementById('stop');

  window.AudioContext = window.AudioContext||window.webkitAudioContext;
  context = new AudioContext();
  
  // play noise to trigger the context.currentTime
  var noise = context.createOscillator();
  noise.type = 0; // sine
  noise.frequency.value = 1;
  noise.connect(context.destination);
  noise.noteOn(0);
  noise.noteOff(0.1);

  function play() {
    if (!buffer || !!source) {
      return;
    }
    stopb.disabled = false;
    playb.disabled = true;

    source = context.createBufferSource();
    source.buffer = buffer;
    source.loop = true;
    source.connect(context.destination);
    var duration = source.buffer.duration;
    window.source = source;
    display.textContent = 'Syncing Clock';
    console.log('syncing');
    display.textContent = 'Playing';
    var now = clocksync.time();
    var seconds_today = now % (86400000) / 1000;
    var offset = (seconds_today + 2) % duration;
    console.log('start at', context.currentTime, offset);
    source.start(context.currentTime + 2, offset);
  }

  function stop() {
    if (!source) {
      return;
    }
    stopb.disabled = true;
    playb.disabled = false;
    display.textContent = 'Stopped';
    source.stop(0); 
    source = undefined;
  }

  console.log('Syncing clock');
  clocksync.sync(function() {
    console.log('Clock synced');
    display.textContent = 'Loading music';
    console.log('loading buffer');
    var request = new XMLHttpRequest();
    request.open('GET', 'http://commondatastorage.googleapis.com/arcade-fire%2Fonye_akpa.mp3', true);
    request.responseType = 'arraybuffer';
    request.onload = function() {
      context.decodeAudioData(request.response, function(b) {
        display.textContent = 'Music Loaded';
        buffer = b;
        play();
      });
    };
    request.send();
  });

  function loop() {
    seconds.textContent = (clocksync.time() % 60000 / 1000);
    requestAnimationFrame(loop);
  }

  loop();

</script>
</body>
</html>